/* generated by template _lsp.language_access.LanguageAccess*/

package de.monticore.lang.sd4development._lsp.language_access;

import de.monticore.lang.sdbasis._ast.ASTSDArtifact;
import de.monticore.lang.sd4development._lsp.SD4DevelopmentLspAntlrParser;
import de.monticore.lang.sd4development._lsp.SD4DevelopmentLspAntlrLexer;
import de.monticore.lang.sd4development._lsp.features.completion.SD4DevelopmentCompletionAntlrParser;
import de.monticore.lang.sd4development._parser.SD4DevelopmentAntlrLexer;
import de.monticore.lang.sd4development._parser.SD4DevelopmentParserInfo;
import de.monticore.lang.sd4development._symboltable.ISD4DevelopmentArtifactScope;
import de.monticore.lang.sd4development._symboltable.SD4DevelopmentGlobalScope;
import org.antlr.v4.runtime.CharStreams;
import org.antlr.v4.runtime.CommonTokenStream;

import java.util.*;
import de.se_rwth.commons.logging.Log;
import de.monticore.prettyprint.AstPrettyPrinter;
import de.mclsg.lsp.document_management.DocumentManager;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class SD4DevelopmentLanguageAccess implements de.mclsg.lsp.features.CoCoCheckProvider {
    private static final Logger logger = LoggerFactory.getLogger(SD4DevelopmentLanguageAccess.class);
    protected DocumentManager documentManager;
    protected SD4DevelopmentScopeManager scopeManager;
    protected SD4DevelopmentLspCoCoRunner lspCoCoRunner;

    public SD4DevelopmentLanguageAccess(DocumentManager documentManager, SD4DevelopmentScopeManager scopeManager){
        this.scopeManager = scopeManager;
        this.documentManager = documentManager;

        lspCoCoRunner = initializeLspCoCoRunner();
    }

    protected void initParserInfo(){
    	SD4DevelopmentParserInfo.init();
    }

    protected SD4DevelopmentLspCoCoRunner initializeLspCoCoRunner(){
        return new SD4DevelopmentLspCoCoRunner(documentManager);
    }

    public SD4DevelopmentCompletionAntlrParser getCompletionParser(String input) {
		SD4DevelopmentLspAntlrLexer lexer = getLexer(input);
		SD4DevelopmentCompletionAntlrParser parser = new SD4DevelopmentCompletionAntlrParser(new CommonTokenStream(lexer));
        lexer.setMCParser(parser);
        initParserInfo();
        return parser;
    }

    public boolean needsSymbolsForCoCos(){
        return lspCoCoRunner.needsSymbols();
    }

    public SD4DevelopmentScopeManager getScopeManager(){
        return scopeManager;
    }

    public void runCoCos(ASTSDArtifact ast) {
    	try{
        	lspCoCoRunner.runAllCoCos(ast);
        }catch(Exception e){
        	// Soft fail => All Findings from CoCos run until the Exception is thrown can be displayed to the user
        	logger.warn("Error while running CoCos", e);
        	Log.error("Unknown error in model", e); // Will be reported to user via diagnostics
        }
    }

    public void runCoCosForAllDocuments() {
        try{
            lspCoCoRunner.runCoCosForAllDocuments();
        }catch(Exception e){
            // Soft fail => All Findings from CoCos run until the Exception is thrown can be displayed to the user
            logger.warn("Error while running CoCos", e);
            Log.error("Unknown error in model", e); // Will be reported to user via diagnostics
        }
    }

    public SD4DevelopmentLspAntlrParser getLspParser(String input) {
      SD4DevelopmentLspAntlrLexer lexer = getLexer(input);
      SD4DevelopmentLspAntlrParser parser = new SD4DevelopmentLspAntlrParser(new CommonTokenStream(lexer));
      lexer.setMCParser(parser);
      parser.lexer = lexer;
      initParserInfo();
      return parser;
    }

    public SD4DevelopmentLspAntlrLexer getLexer(String input) {
        return new SD4DevelopmentLspAntlrLexer(CharStreams.fromString(input));
    }

	/**
	 * Needs to be manually defined via the TOP-Mechanism
	 * @return an ASTPrettyPrinter for the start production ASTNode ASTSDArtifact wrapped in an Optional if available, otherwise Optional.empty
	 */
    public Optional<AstPrettyPrinter<ASTSDArtifact>> getPrettyPrinter(){
      return Optional.empty();
    }

}
